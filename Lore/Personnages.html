<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personnages ‚Äî Rupture JDR</title>
    <link rel="stylesheet" href="../style.css">
    <style>
        .search-wrapper {
            position: relative;
            margin-bottom: 30px;
        }
        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(90, 110, 226, 0.95);
            border-radius: 12px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            z-index: 100;
            box-shadow: 0 8px 24px rgba(0,0,0,0.25);
            margin-top: 4px;
        }
        .search-suggestions.show {
            display: block;
        }
        .suggestion-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            transition: background 0.15s;
        }
        .suggestion-item:hover {
            background: rgba(255,255,255,0.1);
        }
        .suggestion-item:last-child {
            border-bottom: none;
        }
        .suggestion-label {
            font-size: 0.85rem;
            opacity: 0.7;
            margin-top: 2px;
        }

        .personnages-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 30px;
        }

        .personnage-card {
            background: rgba(255,255,255,0.09);
            border-radius: 18px;
            padding: 28px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            transition: transform 0.3s, box-shadow 0.3s;
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 28px;
            align-items: start;
        }
        .personnage-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
        }

        .personnage-card.unseen {
            opacity: 0.65;
            border: 2px dashed rgba(255,255,255,0.2);
        }

        .perso-img-wrapper {
            position: relative;
        }

        .perso-img {
            width: 100%;
            height: 360px;
            border-radius: 14px;
            object-fit: cover;
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
        }

        .seen-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(0, 184, 148, 0.9);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .seen-badge.unseen {
            background: rgba(255, 71, 87, 0.9);
        }

        .perso-content {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .perso-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
        }

        .perso-title h3 {
            font-size: 1.6rem;
            color: #74b9ff;
            margin-bottom: 4px;
        }

        .perso-age {
            font-size: 1rem;
            opacity: 0.8;
        }

        .perso-edit-btn {
            background: rgba(255,255,255,0.12);
            border: none;
            color: #74b9ff;
            padding: 8px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            transition: background 0.2s;
            flex-shrink: 0;
            white-space: nowrap;
        }
        .perso-edit-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .perso-motcles {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .motcle-badge {
            background: linear-gradient(135deg, #74b9ff, #00b894);
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .perso-info {
            font-size: 1rem;
            line-height: 1.6;
            color: rgba(255,255,255,0.9);
            text-align: justify;
        }

        .perso-mj {
            background: rgba(255,0,0,0.1);
            border-left: 4px solid #ff4757;
            padding: 14px;
            border-radius: 8px;
            font-size: 0.95rem;
            color: #ffb3b3;
        }

        .perso-mj strong {
            display: block;
            margin-bottom: 4px;
            color: #ff6b7a;
        }

        /* Modal d'√©dition */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1001;
            align-items: center;
            justify-content: center;
        }
        .modal.show {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, rgb(102, 126, 234), #764ba2);
            border-radius: 18px;
            padding: 30px;
            max-width: 700px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(255,255,255,0.2);
            padding-bottom: 12px;
        }

        .modal-header h2 {
            font-size: 1.6rem;
            color: #74b9ff;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.8rem;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #e0e0e0;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: white;
            font-family: inherit;
            font-size: 0.95rem;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #74b9ff;
            background: rgba(255,255,255,0.15);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 120px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            justify-content: flex-end;
        }

        .btn-save, .btn-cancel {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-save {
            background: linear-gradient(135deg, #00b894, #00a86b);
            color: white;
        }
        .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,184,148,0.3);
        }

        .btn-cancel {
            background: rgba(255,255,255,0.2);
            color: white;
        }
        .btn-cancel:hover {
            background: rgba(255,255,255,0.3);
        }

        .no-results {
            text-align: center;
            padding: 40px;
            opacity: 0.7;
            font-style: italic;
        }

        .dev-badge {
            display: inline-block;
            background: #ff4757;
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 700;
            margin-left: 8px;
        }

        @media (max-width: 900px) {
            .personnage-card {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            .perso-img {
                height: 280px;
            }
        }
    </style>
</head>
<body>
    <div id="navbar-container"></div>
    <script src="../navbar.js"></script>

    <div class="content-wrapper">
        <div class="header">
            <h1>Personnages</h1>
            <p>D√©couvrez les habitants de Rupture</p>
        </div>

        <section class="tier-section">
            <div id="toolsContainer"></div>

            <div class="search-wrapper">
                <input 
                    type="text" 
                    id="searchPersonnage" 
                    class="search-bar" 
                    placeholder="Rechercher par nom ou mot-cl√©..."
                    aria-label="Rechercher un personnage"
                >
                <div class="search-suggestions" id="suggestions"></div>
            </div>
        </section>

        <div id="personnagesContainer" class="personnages-list"></div>
        <div id="noResults" class="no-results" style="display:none;">
            Aucun personnage ne correspond √† votre recherche.
        </div>
    </div>

    <!-- Modal d'√©dition -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>√âditer <span id="editName"></span></h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <form id="editForm">
                <div class="form-group">
                    <label for="editNom">Nom</label>
                    <input type="text" id="editNom" required>
                </div>
                <div class="form-group">
                    <label for="editMotClef">Mots-cl√©s (s√©par√©s par des virgules)</label>
                    <input type="text" id="editMotClef" placeholder="ex: Guilde, Guerrier, Silent Howl">
                </div>
                <div class="form-group">
                    <label for="editAge">√Çge</label>
                    <input type="number" id="editAge" required>
                </div>
                <div class="form-group">
                    <label for="editInfoPublique">Information Publique</label>
                    <textarea id="editInfoPublique" required></textarea>
                </div>
                <div class="form-group" id="mjGroupContainer" style="display:none;">
                    <label for="editInfoMJ">Information MJ</label>
                    <textarea id="editInfoMJ"></textarea>
                </div>
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="editSeen">
                        <label for="editSeen" style="margin: 0;">Personnage rencontr√©</label>
                    </div>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn-cancel" onclick="closeModal()">Annuler</button>
                    <button type="submit" class="btn-save">Sauvegarder</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let personnages = [];
        let currentEditId = null;
        const isDev = location.hostname === 'localhost' || location.hostname === '127.0.0.1' || location.protocol === 'file:';

        async function loadPersonnages() {
            try {
                // Cr√©er les boutons dev si n√©cessaire
                if (isDev) {
                    const toolsContainer = document.getElementById('toolsContainer');
                    toolsContainer.innerHTML = `
                        <div class="tools">
                            <button id="btnNewPerso">‚ûï Nouveau personnage</button>
                            <button id="btnOpenFile">üìÇ Ouvrir fichier personnage.json</button>
                            <button id="btnSaveFile">üíæ Enregistrer sur disque</button>
                            <button id="btnReset">üîÑ R√©initialiser depuis fichier</button>
                            <input id="importFile" type="file" accept=".json" style="display:none">
                        </div>
                    `;
                    
                    // Attacher les listeners APR√àS cr√©ation
                    document.getElementById('btnNewPerso').addEventListener('click', createNewPersonnage);
                    document.getElementById('btnOpenFile').addEventListener('click', openFileWithPicker);
                    document.getElementById('btnSaveFile').addEventListener('click', saveToPickedFile);
                    document.getElementById('btnReset').addEventListener('click', resetFromFile);
                    document.getElementById('importFile').addEventListener('change', handleImportFile);
                }

                const res = await fetch('../personnage.json');
                personnages = res.ok ? await res.json() : [];
                renderPersonnages(personnages);
            } catch (err) {
                console.error("Erreur chargement personnage.json", err);
            }
        }

        function renderPersonnages(toRender) {
            const container = document.getElementById('personnagesContainer');
            const noResults = document.getElementById('noResults');

            container.innerHTML = '';

            if (toRender.length === 0) {
                noResults.style.display = 'block';
                return;
            }
            noResults.style.display = 'none';

            toRender.forEach(perso => {
                // Ne pas afficher du tout les personnages non rencontr√©s pour les visiteurs
                if (!isDev && perso.seen === false) return;

                const card = document.createElement('div');
                card.className = `personnage-card ${!perso.seen ? 'unseen' : ''}`;

                let imgSrc = '../img/' + (perso.image && perso.image !== 'none' ? perso.image : 'placeholder.png');
                let mjSection = '';
                let seenBadge = `<div class="seen-badge ${!perso.seen ? 'unseen' : ''}">
                    ${perso.seen ? '‚úì Rencontr√©' : '? Non rencontr√©'}
                </div>`;

                if (isDev && perso.infoMJ) {
                    mjSection = `<div class="perso-mj"><strong>üí¨ Info MJ:</strong> ${perso.infoMJ}</div>`;
                }

                card.innerHTML = `
                    <div class="perso-img-wrapper">
                        <img src="${imgSrc}" alt="${perso.Nom}" class="perso-img" onerror="this.src='../img/placeholder.png'">
                        ${seenBadge}
                    </div>
                    <div class="perso-content">
                        <div class="perso-header">
                            <div class="perso-title">
                                <h3>${perso.Nom}${isDev ? '<span class="dev-badge">DEV</span>' : ''}</h3>
                                <div class="perso-age">üéÇ ${perso.age} ans</div>
                            </div>
                            ${isDev ? `<button type="button" class="perso-edit-btn" onclick="openModal(${perso.id})">‚úèÔ∏è √âditer</button>` : ''}
                        </div>
                        ${perso.motClef && perso.motClef.length > 0 ? `
                            <div class="perso-motcles">
                                ${perso.motClef.map(mc => `<span class="motcle-badge">${mc}</span>`).join('')}
                            </div>
                        ` : ''}
                        <div class="perso-info">${perso.infoPublique}</div>
                        ${mjSection}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function filterPersonnages(query) {
            if (!query.trim()) {
                renderPersonnages(personnages);
                document.getElementById('suggestions').classList.remove('show');
                return;
            }

            const filtered = personnages.filter(perso => {
                const nom = (perso.Nom || '').toLowerCase();
                const motcles = (perso.motClef || []).map(m => m.toLowerCase());
                const q = query.toLowerCase();

                return nom.includes(q) || motcles.some(m => m.includes(q));
            });

            renderPersonnages(filtered);

            // Afficher les suggestions
            const suggestions = document.getElementById('suggestions');
            suggestions.innerHTML = '';

            const nomMatches = personnages.filter(p => p.Nom.toLowerCase().includes(query.toLowerCase()));
            const motcleMatches = personnages.filter(p => 
                p.motClef && p.motClef.some(m => m.toLowerCase().includes(query.toLowerCase()))
            );

            if (nomMatches.length > 0) {
                nomMatches.forEach(p => {
                    const item = document.createElement('div');
                    item.className = 'suggestion-item';
                    item.innerHTML = `<strong>${p.Nom}</strong><div class="suggestion-label">Personnage</div>`;
                    item.onclick = () => {
                        document.getElementById('searchPersonnage').value = p.Nom;
                        filterPersonnages(p.Nom);
                    };
                    suggestions.appendChild(item);
                });
            }

            if (motcleMatches.length > 0 && nomMatches.length === 0) {
                const uniqueMotcles = [...new Set(
                    motcleMatches.flatMap(p => p.motClef || [])
                        .filter(m => m.toLowerCase().includes(query.toLowerCase()))
                )];

                uniqueMotcles.forEach(mc => {
                    const item = document.createElement('div');
                    item.className = 'suggestion-item';
                    item.innerHTML = `<strong>${mc}</strong><div class="suggestion-label">Mot-cl√©</div>`;
                    item.onclick = () => {
                        document.getElementById('searchPersonnage').value = mc;
                        filterPersonnages(mc);
                    };
                    suggestions.appendChild(item);
                });
            }

            suggestions.classList.toggle('show', suggestions.children.length > 0);
        }

        function openModal(id) {
            const perso = personnages.find(p => p.id === id);
            if (!perso) return;
 
            currentEditId = id;
            document.getElementById('editName').textContent = perso.Nom || 'Sans nom';
            document.getElementById('editNom').value = perso.Nom || '';
            document.getElementById('editMotClef').value = (perso.motClef || []).join(', ');
 
            document.getElementById('editAge').value = perso.age;
            document.getElementById('editInfoPublique').value = perso.infoPublique;
            document.getElementById('editInfoMJ').value = perso.infoMJ || '';
            document.getElementById('editSeen').checked = perso.seen || false;

            // Afficher le groupe MJ seulement en dev
            document.getElementById('mjGroupContainer').style.display = isDev ? 'block' : 'none';

            document.getElementById('editModal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('editModal').classList.remove('show');
            currentEditId = null;
        }

        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const perso = personnages.find(p => p.id === currentEditId);
            if (!perso) return;

            // Mettre √† jour les champs
            const newName = document.getElementById('editNom').value.trim();
            if (newName) {
                perso.Nom = newName;
            }

            // parse motClef (comma separated)
            const rawMot = document.getElementById('editMotClef').value || '';
            perso.motClef = rawMot.split(',')
                .map(s => s.trim())
                .filter(Boolean);

            perso.age = parseInt(document.getElementById('editAge').value) || perso.age;
            perso.infoPublique = document.getElementById('editInfoPublique').value;
            perso.seen = document.getElementById('editSeen').checked;
            if (isDev) perso.infoMJ = document.getElementById('editInfoMJ').value;

            renderPersonnages(personnages);
            closeModal();

            // Essayer d'enregistrer automatiquement sur le fichier ouvert (File System API)
            // Silence les erreurs pour √©viter la popup d'alerte inutile.
            try {
                if (fileHandle || 'showSaveFilePicker' in window) {
                    await saveToPickedFile();
                }
            } catch (err) {
                console.debug('Auto-save ignored error:', err);
                // pas d'alert ici pour √©viter la popup
            }
        });

        // Fermer modal en cliquant dehors
        document.getElementById('editModal').addEventListener('click', (e) => {
            if (e.target.id === 'editModal') closeModal();
        });

        // Event listener pour la recherche
        document.getElementById('searchPersonnage').addEventListener('input', (e) => {
            filterPersonnages(e.target.value);
        });

        let fileHandle = null; // handle choisi par l'utilisateur (si disponible)

        // Ouvrir et lire un fichier JSON via File System Access API (pr√©f√©r√©)
        async function openFileWithPicker() {
            try {
                if ('showOpenFilePicker' in window) {
                    const [handle] = await window.showOpenFilePicker({
                        types: [{ description: 'JSON', accept: { 'application/json': ['.json'] } }],
                        multiple: false
                    });
                    fileHandle = handle;
                    const file = await handle.getFile();
                    const text = await file.text();
                    personnages = JSON.parse(text);
                    persistLocalIfNeeded(); // optional helper if you keep local persistence
                    renderPersonnages(personnages);
                    alert('Fichier charg√© depuis : ' + file.name);
                    return;
                }
            } catch (err) {
                console.error(err);
                alert('Erreur ouverture fichier : ' + (err.message || err));
            }

            // fallback : demander via input file
            document.getElementById('importFile').click();
        }

        async function saveToPickedFile() {
            try {
                if (fileHandle && 'createWritable' in fileHandle) {
                    const writable = await fileHandle.createWritable();
                    await writable.write(JSON.stringify(personnages, null, 2));
                    await writable.close();
                    alert('‚úÖ Enregistr√© dans le fichier s√©lectionn√©');
                    return;
                }

                // si l'API existe mais on n'a pas encore de handle, proposer save picker
                if ('showSaveFilePicker' in window) {
                    const handle = await window.showSaveFilePicker({
                        suggestedName: 'personnage.json',
                        types: [{ description: 'JSON', accept: { 'application/json': ['.json'] } }]
                    });
                    fileHandle = handle;
                    const writable = await handle.createWritable();
                    await writable.write(JSON.stringify(personnages, null, 2));
                    await writable.close();
                    alert('‚úÖ Enregistr√© avec succ√®s');
                    return;
                }

            } catch (err) {
                console.error(err);
                alert('Erreur sauvegarde : ' + (err.message || err));
            }

            // fallback final : t√©l√©charger le JSON pour copie manuelle
            downloadJSONFallback();
        }

        function downloadJSONFallback() {
            const blob = new Blob([JSON.stringify(personnages, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'personnage-export.json';
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
            alert('T√©l√©chargement pr√™t ‚Äî remplace manuellement personnage.json si n√©cessaire.');
        }

        // Nouveau personnage
        function createNewPersonnage() {
            const newId = Math.max(...personnages.map(p => p.id || 0), 0) + 1;
            const newPerso = {
                id: newId,
                Nom: "",
                motClef: [],
                age: 30,
                image: "none",
                infoPublique: "",
                infoMJ: "",
                seen: false
            };
            personnages.push(newPerso);
            renderPersonnages(personnages);
            // ouvrir modal et laisser l'utilisateur saisir le nom directement
            openModal(newId);
        }

        // Hook boutons
        if (document.getElementById('btnOpenFile')) {
            document.getElementById('btnOpenFile').addEventListener('click', openFileWithPicker);
        }
        if (document.getElementById('btnSaveFile')) {
            document.getElementById('btnSaveFile').addEventListener('click', saveToPickedFile);
        }
        const importEl = document.getElementById('importFile');
        if (importEl) {
            importEl.addEventListener('change', (e) => {
                const f = e.target.files[0];
                if (!f) return;
                const reader = new FileReader();
                reader.onload = () => {
                    try {
                        const data = JSON.parse(reader.result);
                        if (!Array.isArray(data)) throw new Error('Format invalide (tableau attendu)');
                        personnages = data;
                        renderPersonnages(personnages);
                        alert('Import OK');
                    } catch (err) {
                        alert('Erreur import: ' + (err.message || err));
                    }
                };
                reader.readAsText(f);
                e.target.value = '';
            });
        }

        // ‚úÖ GARDE SEULEMENT LES D√âFINITIONS DE FONCTIONS :
        function resetFromFile() {
            if (!confirm('R√©initialiser depuis personnage.json et perdre les modifications ?')) return;
            loadPersonnages();
            alert('R√©initialis√© depuis personnage.json');
        }
        
        function handleImportFile(e) {
            const f = e.target.files[0];
            if (!f) return;
            const reader = new FileReader();
            reader.onload = () => {
                try {
                    const data = JSON.parse(reader.result);
                    if (!Array.isArray(data)) throw new Error('Format invalide');
                    personnages = data;
                    renderPersonnages(personnages);
                    alert('Import OK');
                } catch (err) {
                    alert('Erreur import: ' + (err.message || err));
                }
            };
            reader.readAsText(f);
            e.target.value = '';
        }

        function persistLocalIfNeeded() { /* optional no-op */ }

        // Charger les personnages
        loadPersonnages();
    </script>
</body>
</html>