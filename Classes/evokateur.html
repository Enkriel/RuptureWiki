<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evokateur - Rupture JDR</title>
    <link rel="stylesheet" href="../style.css">
</head>
<body>
    <div id="navbar-container"></div>
    <script src="../navbar.js"></script>

    <div class="content-wrapper">
        <div class="header">
            <h1>Evokateur</h1>
            <p>Reliés au multiples dieux de ce monde, il se sert de sa fois pour matérialiser leur pouvoirs</p>
        </div>

        <div class="stats-section">
            <h2>Statistiques de base</h2>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value">8</div>
                    <div class="stat-label">Évasion</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">8</div>
                    <div class="stat-label">PV</div>
                </div>
            </div>

            <h2>Maitrises</h2>
            <div class="mastery-list">
                <span class="mastery-item">Catalyseur</span>
                <span class="mastery-item">Armure Légère</span>
            </div>
            <br>
            <h2>Équipement de départ</h2>
            <ul id="equipment-list">
                <li>Une arme tier 0 au choix</li>
                <li>Une Armure tier 0 au choix</li>
                <li>Un grimoire contenant 3 sort tier 1 et 1 sort tier 2</li>
            </ul>
        </div>

        <!-- BOUTONS ARCHETYPE TOUJOURS VISIBLES -->
        <div class="archetype-buttons" id="archetype-buttons">
            <p>Choisissez un archétype pour débloquer ses capacités :</p>
            <button class="archetype-btn archetype-unique" data-archetype="unique">
                Les Médecins de Xerneas <br><span>Ils insulfent la vie, quittent a donner leur propre energie vitale</span>
            </button>
            <button class="archetype-btn archetype-meute" data-archetype="meute">
                Les Parieurs de Jirachi <br><span>Coming soon.
                </span>
            </button>
            <button class="archetype-btn archetype-pacte" data-archetype="pacte">
                Les Chevaliers de Zacian et Zamazenta <br><span>Coming soon.</span>
            </button>
            <button class="archetype-btn archetype-meteo" data-archetype="meteo">
                Les météorologues de Rayquaza <br><span>Ils manipulent la météo pour offrir un avantage tactique à eux et leur alliés.</span>
            </button>
        </div>

        <div class="level-progression" id="level-progression">
            <!-- Les niveaux et abilities seront générés ici -->
        </div>
    </div>
    <!-- Tooltip -->
    <div id="attack-tooltip" style="position:absolute; display:none; pointer-events:none; z-index:1000; max-width:300px; padding:8px; background:rgba(0,0,0,0.85); color:#fff; border-radius:5px; font-size:0.9em; box-shadow:0 0 5px #000;"></div>
    <style>
        .data-status {
            cursor: help;
            text-decoration: underline;
            text-decoration-color: rgba(255,255,255,0.75);
            text-decoration-thickness: 1px;
            transition: text-decoration-color 120ms ease;
        }
        .data-status:hover,
        .data-status:focus {
            text-decoration-color: #ffd27a;
            outline: none;
        }
    </style>
    <script>
    // filepath: c:\Users\arthu\Documents\GitHub\RuptureWiki\Classes\ranger.html

    const levelAbilities = {
        1: [
            "Magie Divine",
            "Impact Vitalisant - Action Bonus - Repos Court"
        ],
        2: [
            "Question Divine",
            "Prière"
        ],
        4: [
            "Amélioration de Caractéristiques",
            "Amélioration Défensive"
        ],
        5: [
            "Expertise Martiale"
        ],
        6: [
            "Amélioration de Caractéristiques",
            "Amélioration Défensive",
            
        ],
        8: [
            "Amélioration de Caractéristiques",
            "Amélioration Défensive",         
        ],
        9: [
            "Amélioration de Caractéristiques",
            "Emissaire - 1 à 6 pv - Tour Complet"
        ],
        10: [
            "Expertise Libre"
        ]
    };

    const archetypeAbilities = {
        unique: {
            3: ["Géo-Contrôle - 2pv", "Frappe de soin - 1pv"],
            5: ["Croix Purificatrice - 1 pv - Action Bonus", "Marche de la Vie - 2 pv"],
            7: ["Aura Fééerique - 1 pv à chaque tour"],
            10: [""]
        },
        meute: {
            3: [""],
            5: [""],
            7: [""],
            10: [""]
        },
        pacte: {
            3: ["Frere de bataille - Repos Court", "Bouclier Lycan - Réaction - 2pv"],
            5: ["Epée ou Bouclier", "Saut de Loup - Action de Déplacement - 1pv"],
            7: ["Gladius Maximus - 2 pv", "Aegis Maxima - 2 pv - Réaction"],
            10: [""]
        },
        meteo: {
            3: ["Tempete - 2pv", "Air Lock - 1pv", "Hurletempete - 1pv"],
            5: ["Hurletempete Affligeante", "Pluie et Secheresse - 2pv"],
            7: ["Déchainement Climatique - 1pv", "Draco Ascention - 2pv"],
            10: [""]
        }
    };

    function renderBaseLevels(abilityDescriptions) {
        const progression = document.getElementById("level-progression");
        progression.innerHTML = "";

        [1,2,3,4,5,6,7,8,9,10].forEach(level => {
            const card = document.createElement("div");
            card.className = "level-card";
            card.dataset.level = level;
            card.innerHTML = `
                <div class="level-header">
                    <div class="level-number">Level ${level}</div>
                </div>
                <ul class="ability-list"></ul>
            `;
            const ul = card.querySelector(".ability-list");
            (levelAbilities[level] || []).forEach(name => {
                const desc = abilityDescriptions[name] || "";
                ul.innerHTML += `
                    <li class="ability-item">
                        <div class="ability-name">${name}</div>
                        <div class="ability-description">${desc}</div>
                    </li>
                `;
            });
            progression.appendChild(card);
        });
    }

    function applyArchetype(archetype, abilityDescriptions) {
        // Pour chaque niveau d'archétype
        Object.keys(archetypeAbilities[archetype]).forEach(levelStr => {
            const level = parseInt(levelStr);
            // Trouve la carte de niveau correspondante
            const card = document.querySelector(`.level-card[data-level="${level}"]`);
            if (!card) return;
            const ul = card.querySelector(".ability-list");
            // Supprime les anciennes abilities d'archétype (pour changer d'archétype)
            ul.querySelectorAll(".arch").forEach(el => el.remove());
            // Ajoute les abilities d'archétype
            archetypeAbilities[archetype][level].forEach(name => {
                const desc = abilityDescriptions[name] || "";
                const li = document.createElement("li");
                li.className = `ability-item arch ${archetype}`;
                li.innerHTML = `
                    <div class="ability-name ability-name-${archetype}">${name}</div>
                    <div class="ability-description">${desc}</div>
                `;
                ul.appendChild(li);
            });
        });
    }

    fetch('../ability.json')
    .then(res => res.json())
    .then(data => {
        const abilityDescriptions = {};
        data.forEach(ability => {
            if (ability.Name) abilityDescriptions[ability.Name.trim()] = ability.description;
        });

        renderBaseLevels(abilityDescriptions);

        document.querySelectorAll(".archetype-btn").forEach(btn => {
            btn.addEventListener("click", () => {
                document.querySelectorAll(".archetype-btn").forEach(b => b.classList.remove("active"));
                btn.classList.add("active");

                // NE PAS rappeler renderArchLevels ici !
                const archetype = btn.dataset.archetype;
                applyArchetype(archetype, abilityDescriptions);
            });
        });
    });

    let statusData = {};
    const tooltip = document.getElementById('attack-tooltip');

    async function loadDataFiles() {
        try {
            const statusRes = await fetch('../status.json');
            const statuses = statusRes.ok ? await statusRes.json() : [];
            statuses.forEach(s => {
                if (s.Nom && s.description) statusData[s.Nom.toLowerCase()] = s.description;
            });
        } catch (err) {
            console.error("Erreur chargement JSON passifs/status", err);
        }
    }

    // affichage de la tooltip
    function showTooltip(event, content) {
        tooltip.innerHTML = content;
        tooltip.style.display = 'block';
        positionTooltip(event);
    }
    function hideTooltip() { tooltip.style.display = 'none'; }
    function positionTooltip(event) {
        const pageX = event.pageX ?? (event.touches && event.touches[0] && event.touches[0].pageX) ?? 0;
        const pageY = event.pageY ?? (event.touches && event.touches[0] && event.touches[0].pageY) ?? 0;
        const offset = 12;
        tooltip.style.left = (pageX + offset) + 'px';
        tooltip.style.top = (pageY + offset) + 'px';
        const rect = tooltip.getBoundingClientRect();
        const maxRight = window.innerWidth - 8;
        const maxBottom = window.innerHeight - 8;
        let left = pageX + offset, top = pageY + offset;
        if (rect.width && left + rect.width > maxRight) left = pageX - rect.width - offset;
        if (rect.height && top + rect.height > maxBottom) top = pageY - rect.height - offset;
        if (left < 8) left = 8;
        if (top < 8) top = 8;
        tooltip.style.left = left + 'px';
        tooltip.style.top = top + 'px';
    }

    // déléguation : un seul handler pour tous les .data-status présents ou futurs
    function setupDelegatedStatusTooltips() {
        // mouseenter/mousemove/leave via pointer events
        document.addEventListener('pointermove', (e) => {
            const el = e.target.closest && e.target.closest('.data-status');
            if (el) {
                const nameAttr = el.dataset.statusName || el.getAttribute('data-status-name') || '';
                const key = nameAttr.toLowerCase();
                const desc = statusData[key] || '<em>Description non disponible.</em>';
                const title = nameAttr || 'Statut';
                showTooltip(e, `<strong style="display:block;margin-bottom:6px;">${title}</strong><div style="line-height:1.25">${desc}</div>`);
            } else {
                // si on n'est plus sur un .data-status, masquer
                hideTooltip();
            }
        }, {passive: true});

        // tactile : afficher au tap sur .data-status
        document.addEventListener('touchstart', (ev) => {
            const el = ev.target.closest && ev.target.closest('.data-status');
            if (!el) return;
            const nameAttr = el.dataset.statusName || el.getAttribute('data-status-name') || '';
            const key = nameAttr.toLowerCase();
            const desc = statusData[key] || '<em>Description non disponible.</em>';
            const title = nameAttr || 'Statut';
            showTooltip(ev, `<strong style="display:block;margin-bottom:6px;">${title}</strong><div style="line-height:1.25">${desc}</div>`);
            setTimeout(hideTooltip, 3000);
        }, {passive: true});
    }

    // initialisation
    loadDataFiles();
    setupDelegatedStatusTooltips();
    </script>
</body>
</html>